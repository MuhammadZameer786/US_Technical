<div class="row mb-4">
  <div class="col-12">
    <h1 class="mb-2">
      <i class="bi bi-speedometer2 text-primary"></i> Admin Dashboard
    </h1>
    <p class="text-muted">Overview of your Union Swiss distribution system</p>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body stat-card" style="border-left-color: #3498db;">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <div class="stat-label">Distributors</div>
            <div class="stat-value"><%= @distributors_count %></div>
          </div>
          <div class="bg-primary bg-opacity-10 rounded p-3">
            <i class="bi bi-building fs-1 text-primary"></i>
          </div>
        </div>
        <%= link_to admin_distributors_path, class: "btn btn-primary w-100" do %>
          <i class="bi bi-arrow-right me-1"></i>Manage Distributors
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body stat-card" style="border-left-color: #27ae60;">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <div class="stat-label">Products</div>
            <div class="stat-value"><%= @products_count %></div>
          </div>
          <div class="bg-success bg-opacity-10 rounded p-3">
            <i class="bi bi-box-seam fs-1 text-success"></i>
          </div>
        </div>
        <%= link_to admin_products_path, class: "btn btn-success w-100" do %>
          <i class="bi bi-arrow-right me-1"></i>Manage Products
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body stat-card" style="border-left-color: #f39c12;">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <div class="stat-label">Total Orders</div>
            <div class="stat-value"><%= @orders_count %></div>
          </div>
          <div class="bg-warning bg-opacity-10 rounded p-3">
            <i class="bi bi-cart-check fs-1 text-warning"></i>
          </div>
        </div>
      <%= link_to admin_analytics_path, class: "btn btn-warning w-100" do %>
          <i class="bi bi-graph-up me-1"></i>View Analytics
        <%# </button> %> 
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Search & Filters -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-white border-bottom">
    <h5 class="mb-0">
      <i class="bi bi-funnel me-2"></i>Search & Filter Orders
    </h5>
  </div>
  <div class="card-body">
    <%= search_form_for @q, url: admin_dashboard_path, method: :get do |f| %>
      <div class="row g-3">
        <!-- Order Number Search -->
        <div class="col-md-3">
          <%= f.label :order_number_cont, class: "form-label fw-bold" do %>
            <i class="bi bi-hash me-1"></i>Order Number
          <% end %>
          <%= f.search_field :order_number_cont, 
              class: "form-control", 
              placeholder: "e.g., ORD-2025-001" %>
        </div>
        
        <!-- Distributor Search -->
        <div class="col-md-3">
          <%= f.label :distributor_name_cont, class: "form-label fw-bold" do %>
            <i class="bi bi-building me-1"></i>Distributor Name
          <% end %>
          <%= f.search_field :distributor_name_cont, 
              class: "form-control", 
              placeholder: "Company name..." %>
        </div>

        <!-- User Email Search -->
        <div class="col-md-3">
          <%= f.label :user_email_cont, class: "form-label fw-bold" do %>
            <i class="bi bi-person me-1"></i>User Email
          <% end %>
          <%= f.search_field :user_email_cont, 
              class: "form-control", 
              placeholder: "user@example.com" %>
        </div>

        <!-- Date Range - From -->
        <div class="col-md-3">
          <%= f.label :created_at_gteq, class: "form-label fw-bold" do %>
            <i class="bi bi-calendar me-1"></i>Order Date From
          <% end %>
          <%= f.date_field :created_at_gteq, 
              class: "form-control" %>
        </div>

        <!-- Date Range - To -->
        <div class="col-md-3">
          <%= f.label :created_at_lteq, class: "form-label fw-bold" do %>
            <i class="bi bi-calendar-check me-1"></i>Order Date To
          <% end %>
          <%= f.date_field :created_at_lteq, 
              class: "form-control" %>
        </div>

        <!-- Delivery Date From -->
        <div class="col-md-3">
          <%= f.label :required_delivery_date_gteq, class: "form-label fw-bold" do %>
            <i class="bi bi-truck me-1"></i>Delivery From
          <% end %>
          <%= f.date_field :required_delivery_date_gteq, 
              class: "form-control" %>
        </div>

        <!-- Delivery Date To -->
        <div class="col-md-3">
          <%= f.label :required_delivery_date_lteq, class: "form-label fw-bold" do %>
            <i class="bi bi-truck me-1"></i>Delivery To
          <% end %>
          <%= f.date_field :required_delivery_date_lteq, 
              class: "form-control" %>
        </div>

        <!-- Sort By -->
        <div class="col-md-3">
          <%= f.label :s, class: "form-label fw-bold" do %>
            <i class="bi bi-sort-down me-1"></i>Sort By
          <% end %>
          <%= f.select :s, 
              [
                ['Newest First', 'created_at desc'],
                ['Oldest First', 'created_at asc'],
                ['Order Number A-Z', 'order_number asc'],
                ['Order Number Z-A', 'order_number desc'],
                ['Delivery Date (Earliest)', 'required_delivery_date asc'],
                ['Delivery Date (Latest)', 'required_delivery_date desc'],
                ['Total Amount (Highest)', 'total_amount desc'],
                ['Total Amount (Lowest)', 'total_amount asc']
              ],
              { selected: params.dig(:q, :s) || 'created_at desc' },
              { class: "form-select" } %>
        </div>

        <!-- Action Buttons -->
        <div class="col-md-12">
          <div class="d-flex gap-2">
            <%= f.submit "Apply Filters", class: "btn btn-primary" %>
            <%= link_to admin_dashboard_path, class: "btn btn-outline-secondary" do %>
              <i class="bi bi-x-circle me-1"></i>Clear All
            <% end %>
            
            <% if params[:q].present? %>
              <span class="badge bg-info align-self-center ms-2">
                <i class="bi bi-funnel-fill me-1"></i>Filters Active
              </span>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Recent Orders Table -->
<div class="card shadow-sm">
  <div class="card-header bg-white border-bottom">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="bi bi-clock-history me-2"></i>Orders
      </h5>
      <span class="badge bg-primary"><%= @pagy.count %> total orders</span>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @recent_orders.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>
                <i class="bi bi-hash me-1"></i>Order Number
              </th>
              <th>
                <i class="bi bi-building me-1"></i>Distributor
              </th>
              <th>
                <i class="bi bi-person me-1"></i>User
              </th>
              <th>
                <i class="bi bi-calendar me-1"></i>Order Date
              </th>
              <th>
                <i class="bi bi-truck me-1"></i>Delivery Date
              </th>
              <th class="text-end">
                <i class="bi bi-currency-dollar me-1"></i>Total Amount
              </th>
            </tr>
          </thead>
          <tbody>
            <% @recent_orders.each do |order| %>
              <tr>
                <td>
                  <strong class="text-primary"><%= order.order_number %></strong>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 rounded p-1 me-2">
                      <i class="bi bi-building text-primary"></i>
                    </div>
                    <%= order.distributor.name %>
                  </div>
                </td>
                <td>
                  <small class="text-muted">
                    <i class="bi bi-envelope me-1"></i><%= order.user.email %>
                  </small>
                </td>
                <td>
                  <%= order.created_at.strftime('%d %b %Y') %>
                  <br>
                  <small class="text-muted"><%= order.created_at.strftime('%I:%M %p') %></small>
                </td>
                <td>
                  <span class="badge bg-info">
                    <%= order.required_delivery_date.strftime('%d %b %Y') %>
                  </span>
                </td>
                <td class="text-end">
                  <strong class="text-success">
                    <%= order.order_items.first&.sku&.currency || 'ZAR' %> 
                    <%= number_with_precision(order.total_amount, precision: 2, delimiter: ',') %>
                  </strong>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h4 class="mt-3 text-muted">No Orders Found</h4>
        <% if params[:q].present? %>
          <p class="text-muted">Try adjusting your filters or <%= link_to "clear all filters", admin_dashboard_path, class: "text-primary" %></p>
        <% else %>
          <p class="text-muted">No orders have been placed yet.</p>
        <% end %>
      </div>
    <% end %>
  </div>
  
  <!-- Pagination - MOVED OUTSIDE THE IF BLOCK -->
  <% if @recent_orders.any? %>
    <div class="card-footer bg-light">
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Showing <%= @pagy.from %> to <%= @pagy.to %> of <%= @pagy.count %> orders
        </div>
        <div>
          <%== pagy_bootstrap_nav(@pagy) %>
        </div>
      </div>
    </div>
  <% end %>
</div>