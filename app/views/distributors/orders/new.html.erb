<h1 class="mb-4">Place New Order</h1>

<%= form_with model: @order, url: distributors_orders_path, local: true do |f| %>
  <%# --- SECTION 1: ORDER DETAILS --- %>
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Order Details</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <%= f.label :required_delivery_date, "Required Delivery Date", class: "form-label" %>
            <%= f.date_field :required_delivery_date, class: "form-control", min: Date.tomorrow, required: true %>
            <small class="form-text text-muted">Minimum delivery date is tomorrow.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# --- SECTION 2: PRODUCT SELECTION --- %>
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
      <h5 class="mb-0">Select Products</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU Code</th>
              <th>Unit Price</th>
              <th width="180">Quantity (Pallets)</th>
              <th>Total Value</th>
            </tr>
          </thead>
          <tbody id="order-items">
            <%# Grouping by product works directly on the SKU objects now %>
            <% @available_skus.group_by(&:product).each do |product, skus| %>
              <tr class="table-light">
                <td colspan="5"><strong><%= product.name %></strong></td>
              </tr>
              <% skus.each do |sku| %>
                <tr class="order-item-row" data-price="<%= sku.price %>" data-currency="<%= sku.currency %>">
                  <td><%= sku.name %></td>
                  <td><code><%= sku.sku_code %></code></td>
                  <td class="unit-price">
                    <%= sku.currency %> <%= number_with_precision(sku.price, precision: 2) %>
                  </td>
                  <td>
                    <div class="input-group">
                      <%= number_field_tag "order[items][#{sku.id}][quantity]", 0, 
                          min: 0, 
                          class: "form-control quantity-input", 
                          data: { sku_id: sku.id } %>
                      <span class="input-group-text">Plt</span>
                    </div>
                    <small class="text-muted">1 Plt = 4,800 units</small>
                  </td>
                  <td class="item-total fw-bold text-primary">
                    <%= sku.currency %> 0.00
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="table-primary">
              <th colspan="4" class="text-end align-middle">Grand Total:</th>
              <th id="grand-total" class="fs-4">
                <%= @available_skus.first&.currency || 'ZAR' %> 0.00
              </th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between mb-5">
    <%= link_to "Cancel", distributors_dashboard_path, class: "btn btn-outline-secondary" %>
    <%= f.submit "Place Order", class: "btn btn-success btn-lg", id: "submit-order", disabled: true %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const grandTotalElement = document.getElementById('grand-total');
    const submitButton = document.getElementById('submit-order');

    function updateTotals() {
      let grandTotal = 0;
      let hasItems = false;
      let currencySymbol = "ZAR"; // Default

      document.querySelectorAll('.order-item-row').forEach(function(row) {
        const quantityInput = row.querySelector('.quantity-input');
        const quantity = parseInt(quantityInput.value) || 0;
        const price = parseFloat(row.dataset.price);
        const currency = row.dataset.currency;
        currencySymbol = currency; // Store for the grand total

        const unitsPerPallet = <%= OrderItem::UNITS_PER_PALLET %>;
        const total = unitsPerPallet * quantity * price;

        // Display individual row total
        row.querySelector('.item-total').textContent = `${currency} ${total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        if (quantity > 0) {
          hasItems = true;
          grandTotal += total;
        }
      });

      // Update Grand Total
      grandTotalElement.textContent = `${currencySymbol} ${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      // Toggle submit button
      submitButton.disabled = !hasItems;
    }

    quantityInputs.forEach(function(input) {
      input.addEventListener('input', updateTotals);
    });

    updateTotals(); // Run on load
  });
</script>